<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Torn Ranked War Analyzer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }

    .container {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      max-width: 900px;
      margin: auto;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    input,
    button,
    select {
      padding: 0.5rem;
      margin: 0.5rem 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th,
    td {
      padding: 0.5rem;
      border-bottom: 1px solid #ddd;
    }

    th {
      cursor: pointer;
    }

    .highlight {
      background-color: #ffeeba;
    }

    .stealth-defence {
      background-color: #f8d7da;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Torn Ranked War Analyzer</h2>
    <label>API Key:</label>
    <input type="text" id="apiKey" placeholder="Enter your Torn API key" />
    <button onclick="loadRankedWars()">Load Ranked Wars</button>

    <div id="warSelector" style="display:none;">
      <label>Select a Ranked War:</label>
      <select id="warDropdown"></select>
      <button onclick="loadAttackLogs()">Load Attacks</button>
    </div>

    <div id="tableContainer"></div>
  </div>

  <script>
(function () {
  let apiKey = "";
  let selectedWar = null;
  let warStart = 0;
  let warEnd = 0;
  let faction1 = null;
  let faction2 = null;
  let factionId = null;

  async function fetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (data.error) throw new Error(`${data.error.code}: ${data.error.error}`);
    return data;
  }

  function asArray(x) {
    if (Array.isArray(x)) return x;
    if (x && typeof x === "object") return Object.values(x);
    return [];
  }

  window.loadRankedWars = async function () {
    try {
      apiKey = document.getElementById("apiKey").value.trim();
      if (!apiKey) throw new Error("API key required.");
      const url = `https://api.torn.com/v2/faction?selections=rankedwars&key=${apiKey}`;
      const data = await fetchJson(url);

      // Extract faction ID from the response
      factionId = data.ID ?? data.faction_id ?? data.faction?.id ?? null;
      
      const wars = data.rankedwars;
      if (!Array.isArray(wars) || wars.length === 0) {
        throw new Error("No ranked wars found.");
      }

      const dropdown = document.getElementById("warDropdown");
      dropdown.innerHTML = "";

      wars.forEach((war) => {
        const factions = war.factions || [];
        const nameA = factions[0]?.name ?? "Faction A";
        const nameD = factions[1]?.name ?? "Faction B";
        const start = war.start ?? "";
        const end = war.end ?? "";
        const f1Id = factions[0]?.id ?? "";
        const f2Id = factions[1]?.id ?? "";

        const option = document.createElement("option");
        option.value = war.id;
        option.text = `${nameA} vs ${nameD}`;
        option.dataset.start = start;
        option.dataset.end = end;
        option.dataset.f1 = f1Id;
        option.dataset.f2 = f2Id;
        option.dataset.fid = factionId ?? "";
        dropdown.appendChild(option);
      });

      document.getElementById("warSelector").style.display = "block";
    } catch (e) {
      alert(`Failed to load ranked wars: ${e.message}`);
      console.error(e);
    }
  };

  window.loadAttackLogs = async function () {
    try {
      const dropdown = document.getElementById("warDropdown");
      if (!dropdown.value) throw new Error("Select a war first.");

      selectedWar = dropdown.value;
      warStart = dropdown.selectedOptions[0].dataset.start;
      warEnd = dropdown.selectedOptions[0].dataset.end;
      faction1 = dropdown.selectedOptions[0].dataset.f1;
      faction2 = dropdown.selectedOptions[0].dataset.f2;
      factionId = dropdown.selectedOptions[0].dataset.fid || factionId;

      if (!warStart || !warEnd) throw new Error("Missing war time window.");

      let url = `https://api.torn.com/v2/faction/attacks?from=${warStart}&to=${warEnd}&limit=100&sort=DESC&key=${apiKey}`;
      let allAttacks = [];

      while (url) {
        const page = await fetchJson(url);
        const attacks = asArray(page.attacks);
        const newAttacks = attacks.filter((a) => Number(a?.ranked_war) === 1);
        allAttacks = allAttacks.concat(newAttacks);

        // Fixed pagination with API key
        url = page._metadata?.links?.prev ? `${page._metadata.links.prev}&key=${apiKey}` : null;
      }

      renderTable(allAttacks);
    } catch (e) {
      alert(`Failed to load attacks: ${e.message}`);
      console.error(e);
    }
  };

  function renderTable(attacks) {
    const container = document.getElementById("tableContainer");
    const table = document.createElement("table");
    const headers = ["Time", "Attacker", "Defender", "Result"];

    const thead = document.createElement("thead");
    const tr = document.createElement("tr");
    headers.forEach((h) => {
      const th = document.createElement("th");
      th.textContent = h;
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    attacks.forEach((atk) => {
      const row = document.createElement("tr");

      const attackerName = atk?.attacker?.name ?? "STEALTHED";
      const defenderName = atk?.defender?.name ?? "";
      const attackerFaction = atk?.attacker?.faction ?? "";
      const defenderFaction = atk?.defender?.faction ?? "";
      const isStealth = !atk?.attacker?.name || atk.attacker.name === "N/A";

      // highlight rows involving selected war factions
      const involvesF1F2 =
        [attackerFaction, defenderFaction].includes(String(faction1)) ||
        [attackerFaction, defenderFaction].includes(String(faction2));

      if (
        isStealth &&
        defenderFaction &&
        defenderFaction === String(factionId)
      ) {
        row.className = "stealth-defence";
      } else if (involvesF1F2) {
        row.className = "highlight";
      }

      const ended = Number(atk?.timestamp_ended) || Number(atk?.timestamp) || 0;

      row.innerHTML = `
        <td>${ended ? new Date(ended * 1000).toLocaleString() : ""}</td>
        <td>${attackerName}</td>
        <td>${defenderName}</td>
        <td>${atk?.result ?? ""}</td>
      `;
      tbody.appendChild(row);
    });
    table.appendChild(tbody);

    container.innerHTML = "";
    container.appendChild(table);
  }
})();
  </script>
</body>

</html>
