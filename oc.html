<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OC Accountability Dashboard</title>
  <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="styles.css">
  <style>
    .setup-section {
      background: var(--gray-100);
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 16px;
    }

    .dashboard-content {
      display: none;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .faction-name {
      font-weight: 600;
      color: var(--green);
    }

    .last-updated {
      font-size: 12px;
      color: var(--text-light);
      margin-left: auto;
    }

    .refresh-btn {
      background: transparent;
      border: 1px solid var(--gray-300);
      color: var(--text);
      padding: 6px 12px;
      font-size: 12px;
    }

    .refresh-btn:hover {
      border-color: var(--green);
      background: var(--gray-100);
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--gray-300);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Issues Grid Layout */
    .issues-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 1200px) {
      .issues-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .issues-grid {
        grid-template-columns: 1fr;
      }
    }

    .issue-section {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 280px);
      min-height: 200px;
    }

    .issue-header {
      background: var(--gray-100);
      padding: 10px 14px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--gray-200);
      flex-shrink: 0;
    }

    .issue-count {
      background: var(--red);
      color: var(--white);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      min-width: 20px;
      text-align: center;
    }

    .issue-count.ok {
      background: var(--green);
    }

    .issue-list {
      padding: 0;
      margin: 0;
      list-style: none;
      overflow-y: auto;
      flex: 1;
    }

    .issue-item {
      padding: 8px 14px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .issue-item:last-child {
      border-bottom: none;
    }

    .issue-item:hover {
      background: var(--gray-100);
    }

    .member-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .member-name a {
      color: var(--text);
      text-decoration: none;
    }

    .member-name a:hover {
      color: var(--green);
      text-decoration: underline;
    }

    .issue-detail {
      color: var(--text-light);
      font-size: 12px;
      white-space: nowrap;
      text-align: right;
    }

    .issue-detail.warning {
      color: var(--red);
      font-weight: 500;
    }

    .empty-state {
      padding: 24px 14px;
      text-align: center;
      color: var(--text-light);
      font-size: 13px;
    }

    /* Rewards Tab Styles */
    .rewards-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 1000px) {
      .rewards-row,
      .charts-row {
        grid-template-columns: 1fr;
      }
    }

    .rewards-table-wrapper {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .section-title {
      font-weight: 600;
      font-size: 13px;
      padding: 10px 12px;
      background: var(--gray-100);
      border-bottom: 1px solid var(--gray-200);
    }

    .rewards-table-wrapper table {
      min-width: unset;
      width: 100%;
    }

    .rewards-table-wrapper th,
    .rewards-table-wrapper td {
      padding: 6px 10px;
      font-size: 12px;
    }

    .rewards-table-wrapper th:first-child,
    .rewards-table-wrapper td:first-child {
      text-align: left;
    }

    .rewards-chart-wrapper {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .chart-filters {
      display: flex;
      gap: 4px;
    }

    .chart-filters .filter-btn {
      padding: 4px 10px;
      font-size: 11px;
    }

    .chart-area {
      flex: 1;
      min-height: 220px;
      position: relative;
    }

    .chart-grid {
      position: absolute;
      top: 0;
      left: 50px;
      right: 0;
      bottom: 30px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .grid-line {
      border-top: 1px solid var(--gray-200);
      position: relative;
      height: 0;
    }

    .grid-line:last-child {
      border-top: 1px solid var(--gray-300);
    }

    .y-label {
      position: absolute;
      right: calc(100% + 8px);
      top: -6px;
      font-size: 10px;
      color: var(--text-light);
      white-space: nowrap;
    }

    .bar-chart-area {
      position: absolute;
      top: 0;
      left: 50px;
      right: 0;
      bottom: 30px;
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      gap: 4px;
      padding: 0 10px;
    }

    .bar-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 50px;
    }

    .bar-value {
      font-size: 9px;
      color: var(--text);
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
    }

    .bar {
      width: 70%;
      min-height: 2px;
      transition: height 0.3s ease;
      border-radius: 2px 2px 0 0;
    }

    .bar.respect {
      background: var(--green);
    }

    .bar.money {
      background: var(--red);
    }

    .x-labels {
      position: absolute;
      left: 50px;
      right: 0;
      bottom: 0;
      height: 30px;
      display: flex;
      justify-content: space-around;
      padding: 0 10px;
    }

    .x-label {
      flex: 1;
      max-width: 50px;
      font-size: 8px;
      color: var(--text-light);
      text-align: center;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      transform: rotate(180deg);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding-top: 4px;
    }

    /* Timeline chart */
    .timeline-bar-area {
      position: absolute;
      top: 0;
      left: 50px;
      right: 0;
      bottom: 30px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      padding: 0 4px;
    }

    .timeline-bar {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 0;
    }

    .timeline-bar .bar-value {
      font-size: 8px;
    }

    .timeline-stack {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .timeline-stack .bar {
      width: 100%;
      border-radius: 0;
    }

    .timeline-stack .bar:first-child {
      border-radius: 2px 2px 0 0;
    }

    .timeline-stack .bar.success {
      background: var(--green);
    }

    .timeline-stack .bar.failure {
      background: var(--red);
    }

    .timeline-x-labels {
      position: absolute;
      left: 50px;
      right: 0;
      bottom: 0;
      height: 30px;
      display: flex;
      gap: 2px;
      padding: 0 4px;
    }

    .timeline-x-label {
      flex: 1;
      font-size: 8px;
      color: var(--text-light);
      text-align: center;
      padding-top: 4px;
    }

    .chart-legend {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--gray-200);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-light);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .legend-color.success {
      background: var(--green);
    }

    .legend-color.failure {
      background: var(--red);
    }

    .totals-row {
      font-weight: 600;
      background: var(--gray-100);
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    @media (max-width: 800px) {
      .summary-cards {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 500px) {
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .summary-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      text-align: center;
    }

    .summary-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--green);
    }

    .summary-label {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="nav-brand">Resilience Dashboard</a>
  </nav>

  <div class="container">
    <div class="header">
      <h2>OC Accountability</h2>
    </div>

    <div class="setup-section" id="setupSection">
      <div id="loadingMessage"><span class="loading-spinner"></span> Loading OC data...</div>
      <div id="errorMessage" style="display: none; color: var(--red);"></div>
    </div>

    <div class="dashboard-content" id="dashboardContent">
      <div class="status-bar">
        <span class="faction-name" id="factionName"></span>
        <span class="last-updated" id="lastUpdated"></span>
        <button class="refresh-btn" onclick="refreshData()">Refresh</button>
      </div>

      <div class="tab-container">
        <div class="tab-buttons">
          <button id="issuesTabBtn" class="active" onclick="showTab('issuesTab', 'issuesTabBtn')">Issues</button>
          <button id="rewardsTabBtn" onclick="showTab('rewardsTab', 'rewardsTabBtn')">Rewards</button>
        </div>

        <div id="issuesTab" class="tab-section active">
          <div class="issues-grid">
            <div class="issue-section">
              <div class="issue-header">
                <span>Not in an OC</span>
                <span class="issue-count" id="notInOcCount">0</span>
              </div>
              <ul class="issue-list" id="notInOcList">
                <li class="empty-state">Loading...</li>
              </ul>
            </div>

            <div class="issue-section">
              <div class="issue-header">
                <span>Missing Items</span>
                <span class="issue-count" id="missingItemsCount">0</span>
              </div>
              <ul class="issue-list" id="missingItemsList">
                <li class="empty-state">Loading...</li>
              </ul>
            </div>

            <div class="issue-section">
              <div class="issue-header">
                <span>Below CPR Threshold</span>
                <span class="issue-count" id="lowSuccessCount">0</span>
              </div>
              <ul class="issue-list" id="lowSuccessList">
                <li class="empty-state">Loading...</li>
              </ul>
            </div>
          </div>
        </div>

        <div id="rewardsTab" class="tab-section">
          <div class="summary-cards">
            <div class="summary-card">
              <div class="summary-value" id="totalRespect">0</div>
              <div class="summary-label">Total Respect</div>
            </div>
            <div class="summary-card">
              <div class="summary-value" id="totalMoney">$0</div>
              <div class="summary-label">Total Money</div>
            </div>
            <div class="summary-card">
              <div class="summary-value" id="factionMoney">$0</div>
              <div class="summary-label">Faction Cut (20%)</div>
            </div>
            <div class="summary-card">
              <div class="summary-value" id="successRate">0%</div>
              <div class="summary-label">Success Rate</div>
            </div>
            <div class="summary-card">
              <div class="summary-value" id="completedCount">0</div>
              <div class="summary-label">OCs Completed</div>
            </div>
          </div>

          <div class="rewards-row">
            <div class="rewards-table-wrapper">
              <div class="section-title">By Crime Type</div>
              <table id="rewardsTable">
                <thead>
                  <tr>
                    <th>Crime Type</th>
                    <th>Done</th>
                    <th>Success</th>
                    <th>Respect</th>
                    <th>Avg</th>
                    <th>Money</th>
                    <th>Avg</th>
                  </tr>
                </thead>
                <tbody id="rewardsTableBody">
                </tbody>
              </table>
            </div>

            <div class="rewards-table-wrapper">
              <div class="section-title">Items Received</div>
              <table id="itemsTable">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Qty</th>
                  </tr>
                </thead>
                <tbody id="itemsTableBody">
                </tbody>
              </table>
            </div>
          </div>

          <div class="charts-row">
            <div class="rewards-chart-wrapper">
              <div class="chart-header">
                <div class="chart-title">By Crime Type</div>
                <div class="chart-filters">
                  <button class="filter-btn active" data-metric="respect" onclick="switchMetric('respect')">Respect</button>
                  <button class="filter-btn" data-metric="money" onclick="switchMetric('money')">Money</button>
                </div>
              </div>
              <div class="chart-area" id="metricChartArea"></div>
            </div>

            <div class="rewards-chart-wrapper">
              <div class="chart-header">
                <div class="chart-title">Completions Over Time (Last 30 Days)</div>
              </div>
              <div class="chart-area" id="timelineChartArea"></div>
              <div class="chart-legend">
                <div class="legend-item">
                  <div class="legend-color success"></div>
                  <span>Success</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color failure"></div>
                  <span>Failed</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const CACHE_KEY = 'oc_dashboard_cache';
    const ITEMS_CACHE_KEY = 'oc_dashboard_items';
    
    // Get API key from config.js
    let apiKey = '';
    try {
      if (typeof CONFIG !== 'undefined' && CONFIG.apiKey) {
        apiKey = CONFIG.apiKey;
      }
    } catch (e) {
      console.error('Could not load API key from config.js');
    }

    // Multi-stage crimes to exclude from success/failure calculations
    const MULTI_STAGE_CRIMES = [
      'stacking the deck',
      'no reserve',
      'manifest cruelty',
      'gone fission'
    ];

    // CPR Requirements from userscript
    const CPR_REQUIREMENTS = {
      "blast from the past": {
        "picklock #1": 60,
        "hacker": 60,
        "engineer": 62,
        "bomber": 62,
        "muscle": 62,
        "picklock #2": 50
      },
      "stacking the deck": {
        "hacker": 60,
        "imitator": 60,
        "cat burglar": 60,
        "driver": 55
      },
      "ace in the hole": {
        "hacker": 60,
        "driver": 55,
        "muscle #1": 60,
        "imitator": 60,
        "muscle #2": 60
      },
      "break the bank": {
        "robber": 60,
        "muscle #1": 60,
        "thief #1": 50,
        "muscle #2": 60,
        "muscle #3": 62,
        "thief #2": 62
      },
      "clinical precision": {
        "assassin": 60,
        "cat burglar": 65,
        "cleaner": 65,
        "imitator": 65
      },
      "stage fright": {
        "sniper": 60,
        "enforcer": 60,
        "lookout": 60,
        "muscle #1": 10,
        "muscle #2": 10,
        "muscle #3": 10
      },
      "gaslight the way": {
        "imitator #1": 60,
        "imitator #2": 60,
        "imitator #3": 60,
        "looter #1": 60,
        "looter #2": 5,
        "looter #3": 60
      },
      "bidding war": {
        "robber #1": 50,
        "robber #2": 60,
        "robber #3": 60,
        "bomber #1": 50,
        "bomber #2": 60,
        "driver": 60
      },
      "honey trap": { "_default": 60 },
      "leave no trace": { "_default": 60 },
      "snow blind": { "_default": 60 },
      "pet project": { "_default": 30 },
      "cash me if you can": { "_default": 30 },
      "smoke and wing mirrors": { "_default": 30 },
      "market forces": { "_default": 30 },
      "mob mentality": { "_default": 30 },
      "best of the lot": { "_default": 30 },
      "no reserve": { "_default": 60 },
      "sneaky git grab": { "_default": 60 }
    };

    function getCPRThreshold(crimeName, position, positionNumber) {
      const crimeKey = crimeName.toLowerCase();
      const crimeReqs = CPR_REQUIREMENTS[crimeKey];
      
      if (!crimeReqs) {
        return 70; // Default fallback
      }
      
      // Check for default
      if (crimeReqs._default !== undefined) {
        return crimeReqs._default;
      }
      
      // Build position key (e.g., "muscle #2")
      const posLower = position.toLowerCase();
      const posWithNumber = `${posLower} #${positionNumber}`;
      
      // Try position with number first
      if (crimeReqs[posWithNumber] !== undefined) {
        return crimeReqs[posWithNumber];
      }
      
      // Try just position name (for unique positions)
      if (crimeReqs[posLower] !== undefined) {
        return crimeReqs[posLower];
      }
      
      // Try position #1 as fallback for first occurrence
      if (positionNumber === 1 && crimeReqs[`${posLower} #1`] !== undefined) {
        return crimeReqs[`${posLower} #1`];
      }
      
      return 70; // Default fallback
    }

    function isMultiStageCrime(crimeName) {
      return MULTI_STAGE_CRIMES.includes(crimeName.toLowerCase());
    }

    let crimeExpMembers = [];
    let allMembers = {};
    let ongoingCrimes = [];
    let completedCrimes = [];
    let itemNames = {};
    let currentMetric = 'respect';
    let chartData = [];

    function showTab(tabId, btnId) {
      document.querySelectorAll('.tab-section').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-buttons button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.getElementById(btnId).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!apiKey) {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'Error: Missing config.js or API key. Create a config.js file with: const CONFIG = { apiKey: "your-key-here" };';
        return;
      }

      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        const data = JSON.parse(cached);
        const age = Date.now() - data.timestamp;
        if (age < 3600000) {
          loadFromCache(data);
          return;
        }
      }
      
      // Auto-load fresh data
      loadData();
    });

    let dataRange = { earliest: null, latest: null, crimeCount: 0 };

    function loadFromCache(data) {
      crimeExpMembers = data.crimeExpMembers;
      allMembers = data.allMembers;
      ongoingCrimes = data.ongoingCrimes;
      completedCrimes = data.completedCrimes;
      dataRange = data.dataRange || { earliest: null, latest: null, crimeCount: 0 };

      const itemsCache = localStorage.getItem(ITEMS_CACHE_KEY);
      if (itemsCache) {
        itemNames = JSON.parse(itemsCache);
      }

      document.getElementById('setupSection').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';
      document.getElementById('factionName').textContent = data.factionName || 'Your Faction';
      updateLastUpdated(data.timestamp, dataRange);

      processAndRender();
    }

    function updateLastUpdated(timestamp, range) {
      let text = `Updated: ${new Date(timestamp).toLocaleString()}`;
      if (range && range.earliest && range.latest) {
        const earliest = new Date(range.earliest * 1000).toLocaleDateString();
        const latest = new Date(range.latest * 1000).toLocaleDateString();
        text += ` | Data: ${earliest} - ${latest} (${range.crimeCount} crimes)`;
      }
      document.getElementById('lastUpdated').textContent = text;
    }

    function switchMetric(metric) {
      currentMetric = metric;
      document.querySelectorAll('.chart-filters .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.metric === metric);
      });
      renderMetricChart(chartData);
    }

    async function loadData() {
      if (!apiKey) {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'Error: No API key configured.';
        return;
      }

      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';

      try {
        const crimeExpRes = await fetch(`https://api.torn.com/v2/faction/?selections=crimeexp&key=${apiKey}`);
        const crimeExpData = await crimeExpRes.json();

        if (crimeExpData.error) {
          throw new Error(crimeExpData.error.error);
        }

        crimeExpMembers = crimeExpData.crimeexp || [];

        const basicRes = await fetch(`https://api.torn.com/faction/?selections=basic&key=${apiKey}`);
        const basicData = await basicRes.json();

        if (basicData.error) {
          throw new Error(basicData.error.error);
        }

        allMembers = basicData.members || {};
        const factionName = basicData.name || 'Your Faction';

        let allCrimes = [];
        let offset = 0;
        const maxOffset = 500;
        const thirtyDaysAgo = Math.floor(Date.now() / 1000) - (30 * 24 * 60 * 60);
        let oldestFetched = Date.now() / 1000;

        while (offset < maxOffset) {
          const crimesRes = await fetch(`https://api.torn.com/v2/faction/crimes?key=${apiKey}&offset=${offset}`);
          const crimesData = await crimesRes.json();

          if (crimesData.error) {
            throw new Error(crimesData.error.error);
          }

          const crimes = crimesData.crimes || [];
          if (crimes.length === 0) break;

          allCrimes = allCrimes.concat(crimes);

          crimes.forEach(c => {
            if (c.executed_at && c.executed_at < oldestFetched) {
              oldestFetched = c.executed_at;
            }
            if (c.created_at && c.created_at < oldestFetched) {
              oldestFetched = c.created_at;
            }
          });

          if (oldestFetched < thirtyDaysAgo) break;

          offset += crimes.length;
          await new Promise(r => setTimeout(r, 100));
        }

        ongoingCrimes = allCrimes.filter(c => c.executed_at === null && c.status !== 'Expired');
        completedCrimes = allCrimes.filter(c => c.executed_at !== null);

        let earliestDate = null;
        let latestDate = null;
        completedCrimes.forEach(c => {
          if (!earliestDate || c.executed_at < earliestDate) earliestDate = c.executed_at;
          if (!latestDate || c.executed_at > latestDate) latestDate = c.executed_at;
        });

        const dataRange = {
          earliest: earliestDate,
          latest: latestDate,
          crimeCount: allCrimes.length
        };

        const itemIds = new Set();
        completedCrimes.forEach(crime => {
          if (crime.rewards?.items) {
            crime.rewards.items.forEach(item => itemIds.add(item.id));
          }
        });
        ongoingCrimes.forEach(crime => {
          crime.slots.forEach(slot => {
            if (slot.item_requirement?.id) {
              itemIds.add(slot.item_requirement.id);
            }
          });
        });

        if (itemIds.size > 0) {
          try {
            const itemsRes = await fetch(`https://api.torn.com/torn/?selections=items&key=${apiKey}`);
            const itemsData = await itemsRes.json();
            if (itemsData.items) {
              itemIds.forEach(id => {
                if (itemsData.items[id]) {
                  itemNames[id] = itemsData.items[id].name;
                }
              });
              localStorage.setItem(ITEMS_CACHE_KEY, JSON.stringify(itemNames));
            }
          } catch (e) {
            console.warn('Could not fetch item names:', e);
          }
        }

        const cacheData = {
          timestamp: Date.now(),
          factionName,
          crimeExpMembers,
          allMembers,
          ongoingCrimes,
          completedCrimes,
          dataRange
        };
        localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));

        document.getElementById('setupSection').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
        document.getElementById('factionName').textContent = factionName;
        updateLastUpdated(Date.now(), dataRange);

        processAndRender();

      } catch (err) {
        console.error('Error loading data:', err);
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = `Error: ${err.message}`;
      }
    }

    async function refreshData() {
      document.getElementById('setupSection').style.display = 'block';
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
      await loadData();
    }

    function processAndRender() {
      const membersInCrimes = new Map();

      ongoingCrimes.forEach(crime => {
        crime.slots.forEach(slot => {
          if (slot.user?.id) {
            membersInCrimes.set(slot.user.id, {
              crimeId: crime.id,
              crimeName: crime.name,
              difficulty: crime.difficulty || crime.level || null,
              position: slot.position,
              positionNumber: slot.position_number || 1,
              passRate: slot.checkpoint_pass_rate,
              itemRequired: slot.item_requirement,
              joinedAt: slot.user.joined_at
            });
          }
        });
      });

      const lastParticipation = new Map();
      completedCrimes.forEach(crime => {
        crime.slots.forEach(slot => {
          if (slot.user?.id) {
            const existing = lastParticipation.get(slot.user.id);
            if (!existing || crime.executed_at > existing) {
              lastParticipation.set(slot.user.id, crime.executed_at);
            }
          }
        });
      });

      // 1. Not in an OC
      const notInOc = crimeExpMembers
        .filter(id => !membersInCrimes.has(id))
        .map(id => ({
          id,
          name: allMembers[id]?.name || `Unknown [${id}]`,
          lastOc: lastParticipation.get(id) || null
        }))
        .sort((a, b) => {
          if (!a.lastOc && !b.lastOc) return 0;
          if (!a.lastOc) return -1;
          if (!b.lastOc) return 1;
          return a.lastOc - b.lastOc;
        });

      renderNotInOc(notInOc);

      // 2. Missing items
      const missingItems = [];
      membersInCrimes.forEach((data, id) => {
        if (data.itemRequired && !data.itemRequired.is_available) {
          missingItems.push({
            id,
            name: allMembers[id]?.name || `Unknown [${id}]`,
            crimeName: data.crimeName,
            difficulty: data.difficulty,
            itemId: data.itemRequired.id
          });
        }
      });

      renderMissingItems(missingItems);

      // 3. Below CPR threshold (using per-crime/position thresholds)
      const lowSuccess = [];
      membersInCrimes.forEach((data, id) => {
        if (data.passRate !== null) {
          const threshold = getCPRThreshold(data.crimeName, data.position, data.positionNumber);
          if (data.passRate < threshold) {
            lowSuccess.push({
              id,
              name: allMembers[id]?.name || `Unknown [${id}]`,
              crimeName: data.crimeName,
              difficulty: data.difficulty,
              position: data.position,
              positionNumber: data.positionNumber,
              passRate: data.passRate,
              threshold: threshold
            });
          }
        }
      });
      lowSuccess.sort((a, b) => (a.passRate - a.threshold) - (b.passRate - b.threshold));

      renderLowSuccess(lowSuccess);

      // 4. Rewards
      renderRewards();
    }

    function renderNotInOc(members) {
      const list = document.getElementById('notInOcList');
      const countEl = document.getElementById('notInOcCount');

      countEl.textContent = members.length;
      countEl.classList.toggle('ok', members.length === 0);

      if (members.length === 0) {
        list.innerHTML = '<li class="empty-state">Everyone is in an OC</li>';
        return;
      }

      list.innerHTML = members.map(m => {
        let lastOcText;
        let warningClass = '';
        
        if (m.lastOc) {
          lastOcText = formatTimeAgo(m.lastOc);
        } else {
          lastOcText = 'Not in fetched data';
          warningClass = 'warning';
        }

        return `
          <li class="issue-item">
            <span class="member-name">
              <a href="https://www.torn.com/profiles.php?XID=${m.id}" target="_blank">${m.name}</a>
            </span>
            <span class="issue-detail ${warningClass}">${lastOcText}</span>
          </li>
        `;
      }).join('');
    }

    function renderMissingItems(members) {
      const list = document.getElementById('missingItemsList');
      const countEl = document.getElementById('missingItemsCount');

      countEl.textContent = members.length;
      countEl.classList.toggle('ok', members.length === 0);

      if (members.length === 0) {
        list.innerHTML = '<li class="empty-state">No missing items</li>';
        return;
      }

      list.innerHTML = members.map(m => {
        const tierText = m.difficulty ? ` [T${m.difficulty}]` : '';
        const itemName = itemNames[m.itemId] || `Item #${m.itemId}`;
        return `
          <li class="issue-item">
            <span class="member-name">
              <a href="https://www.torn.com/profiles.php?XID=${m.id}" target="_blank">${m.name}</a>
            </span>
            <span class="issue-detail warning">${m.crimeName}${tierText} - ${itemName}</span>
          </li>
        `;
      }).join('');
    }

    function renderLowSuccess(members) {
      const list = document.getElementById('lowSuccessList');
      const countEl = document.getElementById('lowSuccessCount');

      countEl.textContent = members.length;
      countEl.classList.toggle('ok', members.length === 0);

      if (members.length === 0) {
        list.innerHTML = '<li class="empty-state">No one below CPR threshold</li>';
        return;
      }

      list.innerHTML = members.map(m => {
        const tierText = m.difficulty ? ` [T${m.difficulty}]` : '';
        const posText = m.positionNumber > 1 ? `${m.position} #${m.positionNumber}` : m.position;
        return `
          <li class="issue-item">
            <span class="member-name">
              <a href="https://www.torn.com/profiles.php?XID=${m.id}" target="_blank">${m.name}</a>
            </span>
            <span class="issue-detail warning">${m.passRate}% / ${m.threshold}% - ${posText} (${m.crimeName}${tierText})</span>
          </li>
        `;
      }).join('');
    }

    function renderRewards() {
      const byCrimeType = new Map();
      const itemCounts = new Map();
      let totalRespect = 0;
      let totalMoney = 0;
      let totalSuccess = 0;
      let totalFailed = 0;

      completedCrimes.forEach(crime => {
        const name = crime.name;
        const isMultiStage = isMultiStageCrime(name);
        
        if (!byCrimeType.has(name)) {
          byCrimeType.set(name, { count: 0, success: 0, failed: 0, respect: 0, money: 0, isMultiStage });
        }
        const entry = byCrimeType.get(name);
        entry.count++;

        // Check success/failure - multi-stage crimes are excluded from success/fail counts
        if (!isMultiStage) {
          const isSuccess = crime.rewards && crime.rewards.respect > 0;
          if (isSuccess) {
            entry.success++;
            totalSuccess++;
          } else {
            entry.failed++;
            totalFailed++;
          }
        }

        if (crime.rewards) {
          entry.respect += crime.rewards.respect || 0;
          entry.money += crime.rewards.money || 0;
          totalRespect += crime.rewards.respect || 0;
          totalMoney += crime.rewards.money || 0;

          if (crime.rewards.items) {
            crime.rewards.items.forEach(item => {
              const qty = item.quantity || 1;
              const itemId = item.id;
              const itemName = itemNames[itemId] || `Item #${itemId}`;
              itemCounts.set(itemName, (itemCounts.get(itemName) || 0) + qty);
            });
          }
        }
      });

      const totalOCs = totalSuccess + totalFailed;
      const successPct = totalOCs > 0 ? Math.round((totalSuccess / totalOCs) * 100) : 0;
      const factionCut = Math.round(totalMoney * 0.2);

      // Update summary cards
      document.getElementById('totalRespect').textContent = formatNumber(totalRespect);
      document.getElementById('totalMoney').textContent = '$' + formatNumber(totalMoney);
      document.getElementById('factionMoney').textContent = '$' + formatNumber(factionCut);
      document.getElementById('successRate').textContent = successPct + '%';
      document.getElementById('completedCount').textContent = completedCrimes.length;

      // Sort by respect descending
      const sorted = Array.from(byCrimeType.entries())
        .sort((a, b) => b[1].respect - a[1].respect);

      chartData = sorted;

      // Render crime type table
      const tbody = document.getElementById('rewardsTableBody');
      tbody.innerHTML = sorted.map(([name, data]) => {
        const avgRespect = data.count > 0 ? Math.round(data.respect / data.count) : 0;
        const avgMoney = data.count > 0 ? Math.round(data.money / data.count) : 0;
        const successDisplay = data.isMultiStage ? '-' : `${data.success}/${data.success + data.failed}`;
        return `
          <tr>
            <td>${name}${data.isMultiStage ? ' *' : ''}</td>
            <td>${data.count}</td>
            <td>${successDisplay}</td>
            <td>${formatNumber(data.respect)}</td>
            <td>${formatNumber(avgRespect)}</td>
            <td>$${formatNumber(data.money)}</td>
            <td>$${formatNumber(avgMoney)}</td>
          </tr>
        `;
      }).join('');

      // Add totals row
      const avgTotalRespect = totalOCs > 0 ? Math.round(totalRespect / completedCrimes.length) : 0;
      const avgTotalMoney = totalOCs > 0 ? Math.round(totalMoney / completedCrimes.length) : 0;
      tbody.innerHTML += `
        <tr class="totals-row">
          <td>Total</td>
          <td>${completedCrimes.length}</td>
          <td>${totalSuccess}/${totalOCs}</td>
          <td>${formatNumber(totalRespect)}</td>
          <td>${formatNumber(avgTotalRespect)}</td>
          <td>$${formatNumber(totalMoney)}</td>
          <td>$${formatNumber(avgTotalMoney)}</td>
        </tr>
      `;

      // Render items table
      const itemsSorted = Array.from(itemCounts.entries())
        .sort((a, b) => b[1] - a[1]);

      const itemsTbody = document.getElementById('itemsTableBody');
      if (itemsSorted.length === 0) {
        itemsTbody.innerHTML = '<tr><td colspan="2" style="text-align:center;color:var(--text-light);">No items received</td></tr>';
      } else {
        itemsTbody.innerHTML = itemsSorted.map(([name, qty]) => `
          <tr>
            <td>${name}</td>
            <td>${qty}</td>
          </tr>
        `).join('');
      }

      // Render charts
      renderMetricChart(sorted);
      renderTimelineChart();
    }

    function renderMetricChart(data) {
      const chartArea = document.getElementById('metricChartArea');

      if (data.length === 0) {
        chartArea.innerHTML = '<div class="empty-state">No completed crimes to display</div>';
        return;
      }

      const isRespect = currentMetric === 'respect';
      const values = data.map(([, d]) => isRespect ? d.respect : d.money);
      const maxValue = Math.max(...values);
      const chartHeight = 160;

      // Generate grid lines (5 lines including 0)
      const gridLines = [];
      for (let i = 0; i <= 4; i++) {
        const val = Math.round((maxValue / 4) * (4 - i));
        const label = isRespect ? formatNumber(val) : '$' + formatNumber(val);
        gridLines.push({ value: val, label });
      }

      let html = '<div class="chart-grid">';
      gridLines.forEach(line => {
        html += `<div class="grid-line"><span class="y-label">${line.label}</span></div>`;
      });
      html += '</div>';

      html += '<div class="bar-chart-area">';
      data.forEach(([name, d]) => {
        const value = isRespect ? d.respect : d.money;
        const height = maxValue > 0 ? (value / maxValue) * chartHeight : 0;
        const displayValue = isRespect ? formatNumber(value) : '$' + formatNumber(value);

        html += `
          <div class="bar-group">
            <div class="bar-value">${displayValue}</div>
            <div class="bar respect" style="height: ${height}px" title="${name}: ${displayValue}"></div>
          </div>
        `;
      });
      html += '</div>';

      html += '<div class="x-labels">';
      data.forEach(([name]) => {
        html += `<div class="x-label" title="${name}">${name}</div>`;
      });
      html += '</div>';

      chartArea.innerHTML = html;
    }

    function renderTimelineChart() {
      const chartArea = document.getElementById('timelineChartArea');

      if (completedCrimes.length === 0) {
        chartArea.innerHTML = '<div class="empty-state">No completed crimes to display</div>';
        return;
      }

      // Group by day for last 30 days - exclude multi-stage crimes
      const now = Date.now();
      const dayMs = 24 * 60 * 60 * 1000;
      const days = [];

      for (let i = 29; i >= 0; i--) {
        const dayStart = new Date(now - (i * dayMs));
        dayStart.setHours(0, 0, 0, 0);
        days.push({
          date: dayStart,
          success: 0,
          failed: 0
        });
      }

      completedCrimes.forEach(crime => {
        // Skip multi-stage crimes
        if (isMultiStageCrime(crime.name)) return;

        const crimeDate = new Date(crime.executed_at * 1000);
        crimeDate.setHours(0, 0, 0, 0);
        const crimeTime = crimeDate.getTime();

        const dayIndex = days.findIndex(d => d.date.getTime() === crimeTime);

        if (dayIndex !== -1) {
          const isSuccess = crime.rewards && crime.rewards.respect > 0;
          if (isSuccess) {
            days[dayIndex].success++;
          } else {
            days[dayIndex].failed++;
          }
        }
      });

      const maxCount = Math.max(...days.map(d => d.success + d.failed), 1);
      const chartHeight = 160;

      // Generate grid lines
      const gridLines = [];
      const step = Math.ceil(maxCount / 4);
      for (let i = 0; i <= 4; i++) {
        const val = step * (4 - i);
        gridLines.push({ value: val, label: val.toString() });
      }
      const adjustedMax = step * 4;

      let html = '<div class="chart-grid">';
      gridLines.forEach(line => {
        html += `<div class="grid-line"><span class="y-label">${line.label}</span></div>`;
      });
      html += '</div>';

      html += '<div class="timeline-bar-area">';
      days.forEach(d => {
        const total = d.success + d.failed;
        const successHeight = adjustedMax > 0 ? (d.success / adjustedMax) * chartHeight : 0;
        const failedHeight = adjustedMax > 0 ? (d.failed / adjustedMax) * chartHeight : 0;

        html += '<div class="timeline-bar">';
        if (total > 0) {
          html += `<div class="bar-value">${d.success}/${total}</div>`;
          html += '<div class="timeline-stack">';
          if (d.failed > 0) {
            html += `<div class="bar failure" style="height: ${failedHeight}px"></div>`;
          }
          if (d.success > 0) {
            html += `<div class="bar success" style="height: ${successHeight}px"></div>`;
          }
          html += '</div>';
        }
        html += '</div>';
      });
      html += '</div>';

      html += '<div class="timeline-x-labels">';
      days.forEach((d, i) => {
        const dateLabel = `${d.date.getDate()}/${d.date.getMonth() + 1}`;
        // Show label every 5 days
        const showLabel = i % 5 === 0 || i === days.length - 1;
        html += `<div class="timeline-x-label">${showLabel ? dateLabel : ''}</div>`;
      });
      html += '</div>';

      chartArea.innerHTML = html;
    }

    function formatTimeAgo(timestamp) {
      const seconds = Math.floor(Date.now() / 1000) - timestamp;
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);

      if (days > 0) {
        return `${days}d ago`;
      }
      return `${hours}h ago`;
    }

    function formatNumber(num) {
      if (num >= 1000000000) {
        return (num / 1000000000).toFixed(1) + 'B';
      }
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      }
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }
  </script>
  <script src="theme.js"></script>
</body>
</html>
