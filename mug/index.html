<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Mug Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* Softened colors - still vibrant but less jarring */
      --c-text-1: #1A2626;
      /* Softer dark */
      --c-text-2: #5A6670;
      /* Medium gray */
      --c-accent: #FF8866;
      /* Softer coral */
      --c-accent-2: #4ECDC4;
      /* Softer teal */
      --c-accent-3: #FFD93D;
      /* Softer yellow */
      --c-gold: #FFD700;
      /* 1st place */
      --c-silver: #C0C0C0;
      /* 2nd place */
      --c-bronze: #CD7F32;
      /* 3rd place */
      --c-bg: #FBFBFB;
      --c-bg-2: #F8F7FF;
      --c-card: #FFFFFF;
      --c-border: #E0E0E8;
      /* Softer borders */
      --c-table-head: #F0F3F5;
      --shadow: 0 6px 24px rgba(20, 30, 30, 0.08);
      /* Gentler shadows */
      --radius: 16px;
      --sp-1: 8px;
      --sp-2: 12px;
      --sp-3: 16px;
      --sp-4: 20px;
      --sp-5: 28px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    .container {
      max-width: 1400px;
      height: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--sp-4);
    }

    h1 {
      font-size: 32px;
      font-weight: 700;
      /* Less bold */
      letter-spacing: -0.02em;
      color: var(--c-text-1);
    }

    /* allow page to scroll on small screens */
    html,
    body {
      height: auto;
      background: var(--c-bg);
    }

    body {
      overflow: auto;
      min-height: 100svh;
      padding: 16px;
      padding-left: calc(16px + env(safe-area-inset-left));
      padding-right: calc(16px + env(safe-area-inset-right));
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--c-text-1);
    }

    /* fluid grid that stacks automatically without breakpoints */
    .main-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      min-height: 0;
    }

    /* Left panel (table) - fixed height with scrolling */
    .left-panel {
      display: flex;
      flex-direction: column;
      max-height: 700px;
      /* Fixed height to match right column */
    }

    /* ensure table area can scroll independently */
    .table-wrapper {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--c-border);
      border-radius: 8px;
      background: white;
    }

    /* Custom scrollbar styling */
    .table-wrapper::-webkit-scrollbar {
      width: 8px;
    }

    .table-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
      background: var(--c-accent-2);
      border-radius: 4px;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: var(--c-accent);
    }

    /* right column - always stack cards vertically */
    .right-column {
      display: flex;
      flex-direction: column;
      max-height: 700px;
      width: 100%;
      gap: 1rem;
    }

    /* slightly smaller type on very narrow screens only */
    @media (max-width:420px) {
      h1 {
        font-size: 24px;
      }
    }

    .card {
      background: var(--c-card);
      border: 1px solid var(--c-border);
      /* Thinner border */
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--sp-4);
      display: flex;
      flex-direction: column;
      min-height: 0;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 28px rgba(20, 30, 30, 0.1);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--sp-3);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--c-text-1);
      text-transform: none;
      /* Remove uppercase */
      letter-spacing: normal;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 16px;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      text-align: left;
      padding: 12px 14px;
      background: var(--c-table-head);
      color: var(--c-text-2);
      font-weight: 600;
      border-bottom: 1px solid var(--c-border);
      font-variant-numeric: tabular-nums;
      font-size: 14px;
      letter-spacing: normal;
    }

    tbody td {
      padding: 14px;
      border-bottom: 1px solid var(--c-border);
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    tbody tr {
      transition: background 0.2s ease;
    }

    /* Ranking colors for top 3 */
    tbody tr:nth-child(1) td:first-child::before {
      content: "ðŸ¥‡ ";
      font-size: 18px;
    }

    tbody tr:nth-child(2) td:first-child::before {
      content: "ðŸ¥ˆ ";
      font-size: 18px;
    }

    tbody tr:nth-child(3) td:first-child::before {
      content: "ðŸ¥‰ ";
      font-size: 18px;
    }

    tbody tr:nth-child(1) {
      background: linear-gradient(to right, rgba(255, 215, 0, 0.1), transparent);
    }

    tbody tr:nth-child(2) {
      background: linear-gradient(to right, rgba(192, 192, 192, 0.1), transparent);
    }

    tbody tr:nth-child(3) {
      background: linear-gradient(to right, rgba(205, 127, 50, 0.1), transparent);
    }

    tbody tr:hover {
      background: rgba(78, 205, 196, 0.05);
      /* Softer hover */
    }

    .amount {
      color: var(--c-accent-2);
      font-weight: 600;
      font-size: 16px;
    }

    .highlight {
      text-align: center;
      border: 2px solid var(--c-accent);
      border-radius: 12px;
      background: rgba(255, 136, 102, 0.05);
      transition: all 0.3s ease;
    }

    .highlight:hover {
      background: rgba(255, 136, 102, 0.08);
    }

    .highlight .name {
      display: block;
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--c-text-1);
    }

    .highlight .amount {
      display: block;
      font-weight: 700;
      font-size: 24px;
      color: var(--c-accent);
    }

    .mini-table-wrapper {
      max-height: 150px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--c-border);
      border-radius: 8px;
      background: white;
    }

    /* Custom scrollbar styling for mini tables */
    .mini-table-wrapper::-webkit-scrollbar {
      width: 6px;
    }

    .mini-table-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .mini-table-wrapper::-webkit-scrollbar-thumb {
      background: var(--c-accent-2);
      border-radius: 3px;
    }

    .mini-table-wrapper::-webkit-scrollbar-thumb:hover {
      background: var(--c-accent);
    }

    .mini-table td {
      padding: 12px;
      border-bottom: 1px solid var(--c-border);
      font-weight: 500;
    }

    .mini-table tr:first-child td {
      color: var(--c-accent);
      font-weight: 600;
      font-size: 16px;
    }

    .mini-table tr:nth-child(1) td:first-child::before {
      content: "ðŸ‘‘ ";
    }

    .mini-table tr:nth-child(2) td:first-child {
      color: var(--c-text-1);
      opacity: 0.9;
    }

    .mini-table tr:nth-child(3) td:first-child {
      color: var(--c-text-1);
      opacity: 0.8;
    }

    .last-updated {
      text-align: right;
      color: var(--c-text-2);
      font-size: 13px;
      font-weight: 500;
    }

    /* Compact height */
    @media (max-height:800px) {
      body {
        padding: var(--sp-3)
      }

      h1 {
        font-size: 24px
      }

      .card {
        padding: var(--sp-3)
      }

      .left-panel {
        max-height: 500px;
        /* Smaller on compact screens */
      }

      thead th,
      tbody td {
        padding: 10px
      }
    }

    /* Stack columns on mobile */
    @media (max-width:768px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .left-panel {
        max-height: 400px;
        /* Smaller on mobile */
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Mug statistics</h1>

    <div class="main-layout">
      <div class="card left-panel">
        <div class="card-header">
          <div class="card-title">All players</div>
        </div>
        <div class="table-wrapper">
          <table id="summaryTable">
            <thead>
              <tr>
                <th>Player</th>
                <th>Mugs</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="right-column">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Total mugged</div>
          </div>
          <div id="totalMugged" class="highlight">
            <span class="name">All players</span>
            <span class="amount">$0</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Biggest mug</div>
          </div>
          <div id="biggestMug" class="highlight">
            <span class="name">-</span>
            <span class="amount">$0</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Most mugs</div>
          </div>
          <div class="mini-table-wrapper">
            <table class="mini-table" id="mostMugs">
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Over $500k</div>
          </div>
          <div class="mini-table-wrapper">
            <table class="mini-table" id="over500k">
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="last-updated" id="lastUpdated"></div>
  </div>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkwwZmosyQpHUhgquaC7Ey4M7Ntvk9NtMsediYByuo-NINTpvKOFRW4vAsanJVRgpi1UvWLSj8473y/pub?gid=746974187&single=true&output=csv';
    async function fetchData() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const rows = text.split('\n').slice(1);
        const mugs = rows.filter(r => r.trim()).map(r => {
          const c = r.split(',');
          return {
            code: c[0],
            attackerId: c[1],
            attackerName: (c[2] || '').replace(/"/g, ''),
            timestamp: parseInt(c[3]),
            action: c[4],
            amount: parseFloat(c[5]) || 0
          };
        });
        updateDashboard(mugs);
      } catch (e) {
        console.error('Error fetching data:', e)
      }
    }

    function updateDashboard(mugs) {
      const userStats = {};
      let biggestMug = {
        name: '-',
        amount: 0
      };
      let totalMuggedAmount = 0;
      mugs.forEach(m => {
        const name = m.attackerName || 'Unknown';
        if (!userStats[name]) userStats[name] = {
          count: 0,
          totalAmount: 0,
          over500k: 0
        };
        userStats[name].count++;
        userStats[name].totalAmount += m.amount;
        totalMuggedAmount += m.amount;
        if (m.amount > 500000) userStats[name].over500k++;
        if (m.amount > biggestMug.amount) biggestMug = {
          name,
          amount: m.amount
        };
      });
      // Update total mugged amount
      document.getElementById('totalMugged').innerHTML =
        `<span class="name">All players</span>
         <span class="amount">${totalMuggedAmount.toLocaleString()}</span>`;
      const tbody = document.querySelector('#summaryTable tbody');
      tbody.innerHTML = '';
      Object.entries(userStats)
        .sort((a, b) => b[1].totalAmount - a[1].totalAmount)
        .forEach(([name, stats]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${name}</td><td>${stats.count}</td><td class="amount">${stats.totalAmount.toLocaleString()}</td>`;
          tbody.appendChild(tr);
        });
      document.getElementById('biggestMug').innerHTML =
        `<span class="name">${biggestMug.name}</span>
         <span class="amount">${biggestMug.amount.toLocaleString()}</span>`;
      const mostMugsBody = document.querySelector('#mostMugs tbody');
      mostMugsBody.innerHTML = '';
      Object.entries(userStats)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10)
        .forEach(([name, stats]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${name}</td><td>${stats.count}</td>`;
          mostMugsBody.appendChild(tr);
        });
      const over500kBody = document.querySelector('#over500k tbody');
      over500kBody.innerHTML = '';
      Object.entries(userStats)
        .filter(([, s]) => s.over500k > 0)
        .sort((a, b) => b[1].over500k - a[1].over500k)
        .slice(0, 10)
        .forEach(([name, stats]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${name}</td><td>${stats.over500k}</td>`;
          over500kBody.appendChild(tr);
        });
      document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    }
    fetchData();
    setInterval(fetchData, 30000);
  </script>
</body>

</html>
