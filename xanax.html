<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xanax Tracker</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>Xanax Tracker</h1>
        <a href="index.html" class="nav-link">Dashboard</a>
      </div>
      <div class="controls">
        <input type="text" class="search-box" id="search" placeholder="Search member...">
        
        <div class="filter-group">
          <label>Status:</label>
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="behind">Behind</button>
          <button class="filter-btn" data-filter="ok">On Track</button>
        </div>

        <div class="filter-group">
          <label>Weeks:</label>
          <select class="week-select" id="weekSelect">
            <option value="1">Last week</option>
            <option value="3" selected>Last 3 weeks</option>
            <option value="6">Last 6 weeks</option>
            <option value="12">Last 12 weeks</option>
            <option value="all">All weeks</option>
          </select>
        </div>
      </div>
      <div class="stats-bar">
        <div class="stat">Total: <span class="stat-count" id="totalCount">0</span></div>
        <div class="stat">On Track: <span class="stat-count green" id="okCount">0</span></div>
        <div class="stat">Behind: <span class="stat-count red" id="behindCount">0</span></div>
        <div class="stat">Showing: <span class="stat-count" id="showingCount">0</span></div>
      </div>
    </div>

    <div class="table-wrapper">
      <table id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="loading" id="loading">Loading data...</div>
    </div>
  </div>

  <script>
    var CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSmISHBbWz7ywK8d5VpL45ZJ-IbRdtnHYUpJpLMTjnbKa7beyygtOhoWwBnU60z8ZQzptgIykIiUM8R/pub?gid=1631528527&single=true&output=csv';

    var rawData = [];
    var headers = [];
    var weeks = [];
    var visibleWeeks = new Set();
    var currentFilter = 'all';
    var searchTerm = '';
    var sortCol = null;
    var sortAsc = true;

    var searchInput = document.getElementById('search');
    var weekSelect = document.getElementById('weekSelect');
    var tableHead = document.getElementById('tableHead');
    var tableBody = document.getElementById('tableBody');
    var loading = document.getElementById('loading');
    var filterBtns = document.querySelectorAll('.filter-btn');

    fetch(CSV_URL)
      .then(function(r) { return r.text(); })
      .then(function(csv) {
        parseCSV(csv);
        loading.style.display = 'none';
        updateVisibleWeeks();
        renderTable();
      })
      .catch(function(err) {
        loading.textContent = 'Error loading data: ' + err.message;
      });

    function parseCSV(csv) {
      var rows = csv.trim().split('\n').map(function(r) {
        var result = [];
        var current = '';
        var inQuotes = false;
        
        for (var i = 0; i < r.length; i++) {
          var char = r[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      });

      headers = rows[0];
      rawData = rows.slice(1).map(function(row) {
        var obj = {};
        headers.forEach(function(h, i) {
          obj[h] = row[i] || '';
        });
        return obj;
      });

      weeks = [];
      headers.forEach(function(h) {
        var match = h.match(/^(\d+\/\d+)\s+Avg$/);
        if (match) {
          weeks.push(match[1]);
        }
      });
    }

    function updateVisibleWeeks() {
      var selection = weekSelect.value;
      
      if (selection === 'all') {
        visibleWeeks = new Set(weeks);
      } else {
        var count = parseInt(selection);
        var lastWeeks = weeks.slice(-count);
        visibleWeeks = new Set(lastWeeks);
      }
    }

    weekSelect.addEventListener('change', function() {
      updateVisibleWeeks();
      renderTable();
    });

    function getVisibleStatus(row) {
      var visibleWeeksOrdered = weeks.filter(function(w) { return visibleWeeks.has(w); }).reverse();
      
      for (var i = 0; i < visibleWeeksOrdered.length; i++) {
        var week = visibleWeeksOrdered[i];
        var avg = row[week + ' Avg'];
        var avgNum = parseFloat(avg);
        if (!isNaN(avgNum)) {
          return avgNum >= 2 ? '✓' : 'Behind';
        }
      }
      return '—';
    }

    function getVisibleOD(row) {
      var visibleWeeksOrdered = weeks.filter(function(w) { return visibleWeeks.has(w); }).reverse();
      for (var i = 0; i < visibleWeeksOrdered.length; i++) {
        var week = visibleWeeksOrdered[i];
        var od = row[week + ' OD'];
        if (od && od !== '—') {
          return od;
        }
      }
      return 'No';
    }

    function renderTable() {
      var headerHTML = '<tr>';
      headerHTML += '<th onclick="sortBy(\'Member\')">Member</th>';

      weeks.forEach(function(week) {
        if (!visibleWeeks.has(week)) return;
        headerHTML += '<th class="week-header" onclick="sortBy(\'' + week + ' Total\')">' + week + ' Total</th>';
        headerHTML += '<th onclick="sortBy(\'' + week + ' Avg\')">' + week + ' Avg</th>';
      });

      headerHTML += '<th class="week-header" onclick="sortBy(\'VisibleStatus\')">Status</th>';
      headerHTML += '</tr>';
      tableHead.innerHTML = headerHTML;

      if (sortCol) {
        var ths = tableHead.querySelectorAll('th');
        ths.forEach(function(th) {
          if (th.textContent === sortCol || th.textContent === sortCol.replace(/ (Total|Avg)$/, ' $1')) {
            th.classList.add(sortAsc ? 'sorted-asc' : 'sorted-desc');
          }
        });
      }

      rawData.forEach(function(row) {
        row['VisibleStatus'] = getVisibleStatus(row);
        row['VisibleOD'] = getVisibleOD(row);
      });

      var filtered = rawData.filter(function(row) {
        if (searchTerm && !row['Member']?.toLowerCase().includes(searchTerm.toLowerCase())) {
          return false;
        }
        if (currentFilter === 'behind' && row['VisibleStatus'] !== 'Behind') return false;
        if (currentFilter === 'ok' && row['VisibleStatus'] === 'Behind') return false;
        return true;
      });

      if (sortCol) {
        filtered.sort(function(a, b) {
          var aVal = a[sortCol] || '';
          var bVal = b[sortCol] || '';

          var aNum = parseFloat(aVal);
          var bNum = parseFloat(bVal);

          if (!isNaN(aNum) && !isNaN(bNum)) {
            return sortAsc ? aNum - bNum : bNum - aNum;
          }

          return sortAsc 
            ? aVal.localeCompare(bVal, undefined, { numeric: true })
            : bVal.localeCompare(aVal, undefined, { numeric: true });
        });
      }

      var bodyHTML = '';
      filtered.forEach(function(row) {
        bodyHTML += '<tr>';
        bodyHTML += '<td>' + (row['Member'] || '') + '</td>';

        weeks.forEach(function(week) {
          if (!visibleWeeks.has(week)) return;

          var total = row[week + ' Total'] || '';
          var avg = row[week + ' Avg'] || '';

          bodyHTML += '<td class="week-cell">' + total + '</td>';

          var avgNum = parseFloat(avg);
          var avgClass = '';
          if (!isNaN(avgNum)) {
            avgClass = avgNum >= 2 ? 'avg-ahead' : 'avg-behind';
          }
          bodyHTML += '<td class="' + avgClass + '">' + avg + '</td>';
        });

        var status = row['VisibleStatus'];
        var od = row['VisibleOD'];
        var statusClass = status === 'Behind' ? 'status-behind' : 'status-ok';
        var odDisplay = od.toLowerCase() === 'yes' ? '<br><span style="font-size: 11px;">(OD)</span>' : '';
        bodyHTML += '<td class="week-cell ' + statusClass + '">' + status + odDisplay + '</td>';

        bodyHTML += '</tr>';
      });

      tableBody.innerHTML = bodyHTML;

      var total = rawData.length;
      var behind = rawData.filter(function(r) { return r['VisibleStatus'] === 'Behind'; }).length;
      var ok = rawData.filter(function(r) { return r['VisibleStatus'] === '✓'; }).length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('okCount').textContent = ok;
      document.getElementById('behindCount').textContent = behind;
      document.getElementById('showingCount').textContent = filtered.length;
    }

    function sortBy(col) {
      if (sortCol === col) {
        sortAsc = !sortAsc;
      } else {
        sortCol = col;
        sortAsc = true;
      }
      renderTable();
    }

    searchInput.addEventListener('input', function(e) {
      searchTerm = e.target.value;
      renderTable();
    });

    filterBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        filterBtns.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderTable();
      });
    });
  </script>
  <script src="theme.js"></script>
</body>
</html>
