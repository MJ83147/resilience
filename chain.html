<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chain Performance - Resilience Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="theme.css">
  <style>
    .progress-bar {
      width: 300px;
      height: 4px;
      background: var(--gray-300);
      border-radius: 2px;
      margin: 12px auto 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--green);
      border-radius: 2px;
      transition: width 0.3s;
      width: 0%;
    }

    .loading-container {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-light);
      font-size: 14px;
    }

    .stat-cards {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 18px;
      min-width: 150px;
      flex: 1;
    }

    .stat-card .sc-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-light);
      margin-bottom: 4px;
    }

    .stat-card .sc-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    .stat-card .sc-value.green { color: var(--green); }
    .stat-card .sc-value.red { color: var(--red); }

    /* Two column layout */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 1100px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    .right-stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .panel-header h2 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    .panel-header .sub {
      font-size: 11px;
      color: var(--text-light);
      font-weight: 400;
    }

    .panel-body {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }

    .panel-body table {
      min-width: auto;
    }

    /* Member links */
    td a {
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
    }

    td a:hover {
      color: var(--green);
      text-decoration: underline;
    }

    /* Percentage colors */
    .pct-great { color: var(--green); font-weight: 600; }
    .pct-ok { color: var(--green); }
    .pct-warn { color: #E65100; font-weight: 500; }
    [data-theme="dark"] .pct-warn { color: #FFB74D; }
    .pct-missed { color: #F57C00; }
    [data-theme="dark"] .pct-missed { color: #FFE0B2; }
    .pct-bad { color: var(--red); font-weight: 600; }
    .pct-zero { color: var(--red); font-weight: 700; }
    .pct-absent { color: var(--text-light); }

    .fail-badge {
      display: inline-block;
      background: var(--red-light);
      color: var(--red);
      font-weight: 600;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .pass-badge {
      display: inline-block;
      background: var(--green-light);
      color: var(--green);
      font-weight: 600;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .warn-badge {
      display: inline-block;
      background: #FFF3E0;
      color: #E65100;
      font-weight: 600;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    [data-theme="dark"] .warn-badge {
      background: rgba(255, 183, 77, 0.15);
      color: #FFB74D;
    }

    /* Chain detail section */
    .chain-detail {
      margin-top: 16px;
    }

    .chain-meta {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .chain-meta .cm-item {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      padding: 8px 12px;
      font-size: 12px;
    }

    .chain-meta .cm-item .cm-label {
      color: var(--text-light);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .chain-meta .cm-item .cm-val {
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      margin-top: 1px;
    }

    .hidden { display: none !important; }

    .error-msg {
      text-align: center;
      padding: 40px 20px;
      color: var(--red);
      font-size: 14px;
    }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-light);
      font-size: 13px;
    }

    .rank-cell {
      color: var(--text-light);
      font-size: 12px;
      font-weight: 400;
    }

    .toggle-btn {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-light);
      cursor: pointer;
    }

    .toggle-btn.active {
      background: var(--green-light);
      border-color: var(--green);
      color: var(--green);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="nav-brand">Resilience Dashboard</a>
    <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()"></button>
  </nav>

  <div class="container">
    <div id="loadingState" class="loading-container">
      <p id="loadingText">Loading chain data...</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div id="errorState" class="hidden">
      <div class="error-msg" id="errorMsg"></div>
    </div>

    <div id="mainContent" class="hidden">
      <div class="stat-cards" id="statsRow"></div>

      <div class="main-layout">
        <!-- Left: Toggle between All Members / Chain Detail -->
        <div class="panel">
          <div class="panel-header">
            <div style="display: flex; gap: 8px; align-items: center;">
              <button class="toggle-btn active" id="btnAllMembers" onclick="showLeftView('members')">All Members</button>
              <button class="toggle-btn" id="btnChainDetail" onclick="showLeftView('chain')">Chain Detail</button>
            </div>
            <div id="memberSearchWrap">
              <input type="text" class="search-box" id="memberSearch" placeholder="Search member..." style="flex: 0; min-width: 160px; margin: 0;">
            </div>
            <div id="chainSelectWrap" class="hidden">
              <select id="chainSelect" class="week-select"></select>
            </div>
          </div>
          <div id="chainMeta" class="chain-meta hidden"></div>
          <div class="panel-body" style="max-height: 700px;" id="leftMembersView">
            <table>
              <thead id="allHead"></thead>
              <tbody id="allBody"></tbody>
            </table>
          </div>
          <div class="panel-body hidden" style="max-height: 700px;" id="leftChainView">
            <table>
              <thead id="chainHead"></thead>
              <tbody id="chainBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Right: stacked -->
        <div class="right-stack">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2>Exceeded</h2>
                <span class="sub">Over 100% in every chain</span>
              </div>
            </div>
            <div class="panel-body">
              <table>
                <thead id="exceededHead"></thead>
                <tbody id="exceededBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div>
                <h2>Consistent</h2>
                <span class="sub">Hit 100% in every chain</span>
              </div>
            </div>
            <div class="panel-body">
              <table>
                <thead id="consistentHead"></thead>
                <tbody id="consistentBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div>
                <h2>Offenders</h2>
                <span class="sub">Negative weighted score across last 5 chains</span>
              </div>
            </div>
            <div class="panel-body">
              <table>
                <thead id="offenderHead"></thead>
                <tbody id="offenderBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- Config ----
    var CHAINS_CSV = 'https://docs.google.com/spreadsheets/d/1garCJf8OdTzWaNgdXfOMIKtR3MmG8-kuAjh1r-ln2CE/gviz/tq?tqx=out:csv&sheet=Chains';
    var REPORTS_CSV = 'https://docs.google.com/spreadsheets/d/1garCJf8OdTzWaNgdXfOMIKtR3MmG8-kuAjh1r-ln2CE/gviz/tq?tqx=out:csv&sheet=ChainReports';
    var API_KEY = 'POW66la7QjNjI97z';
    var TORN_BASE = 'https://api.torn.com/v2';

    // ---- State ----
    var currentMembers = {};
    var chains = {};
    var chainRows = {};
    var aggregated = {};
    var sortedChainIds = [];

    // ---- Left panel toggle ----
    function showLeftView(view) {
      var membersView = document.getElementById('leftMembersView');
      var chainView = document.getElementById('leftChainView');
      var searchWrap = document.getElementById('memberSearchWrap');
      var selectWrap = document.getElementById('chainSelectWrap');
      var metaEl = document.getElementById('chainMeta');
      var btnAll = document.getElementById('btnAllMembers');
      var btnChain = document.getElementById('btnChainDetail');

      if (view === 'members') {
        membersView.classList.remove('hidden');
        chainView.classList.add('hidden');
        searchWrap.classList.remove('hidden');
        selectWrap.classList.add('hidden');
        metaEl.classList.add('hidden');
        btnAll.classList.add('active');
        btnChain.classList.remove('active');
      } else {
        membersView.classList.add('hidden');
        chainView.classList.remove('hidden');
        searchWrap.classList.add('hidden');
        selectWrap.classList.remove('hidden');
        metaEl.classList.remove('hidden');
        btnAll.classList.remove('active');
        btnChain.classList.add('active');
      }
    }

    // ---- Helpers ----

    function setProgress(pct, text) {
      document.getElementById('progressFill').style.width = pct + '%';
      if (text) document.getElementById('loadingText').textContent = text;
    }

    function showError(msg) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
      document.getElementById('errorMsg').textContent = msg;
    }

    function formatNumber(n) {
      if (typeof n === 'number') return n.toLocaleString();
      return n;
    }

    function getPctClass(pct) {
      if (pct === 0) return 'pct-zero';
      if (pct < 50) return 'pct-bad';
      if (pct < 75) return 'pct-warn';
      if (pct < 100) return 'pct-missed';
      return 'pct-great';
    }

    function parseCSV(csv) {
      return csv.trim().split('\n').map(function(r) {
        var result = [];
        var current = '';
        var inQuotes = false;
        for (var i = 0; i < r.length; i++) {
          var ch = r[i];
          if (ch === '"') { inQuotes = !inQuotes; }
          else if (ch === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
          else { current += ch; }
        }
        result.push(current.trim());
        return result;
      });
    }

    // ---- Parse sheets ----

    function parseChainsCSV(csv) {
      var rows = parseCSV(csv);
      for (var i = 1; i < rows.length; i++) {
        var id = parseInt(rows[i][0]);
        var length = parseInt(rows[i][1]);
        if (!isNaN(id) && !isNaN(length)) {
          chains[id] = { length: length };
        }
      }
      // Sort by chain ID descending (most recent first)
      sortedChainIds = Object.keys(chains).map(Number).sort(function(a, b) { return b - a; });
    }

    function parseReportsCSV(csv) {
      var rows = parseCSV(csv);
      for (var i = 1; i < rows.length; i++) {
        var row = rows[i];
        if (row.length < 7) continue;
        var chainId = parseInt(row[0]);
        var memberId = parseInt(row[1]);
        if (isNaN(chainId) || isNaN(memberId)) continue;
        if (!chains[chainId]) continue;
        if (!chainRows[chainId]) chainRows[chainId] = [];
        chainRows[chainId].push({
          memberId: memberId,
          hits: parseInt(row[3]) || 0,
          respect: parseFloat(row[4]) || 0,
          avgRespect: parseFloat(row[5]) || 0,
          warHits: parseInt(row[6]) || 0
        });
      }
    }

    // ---- Process ----

    function processData() {
      aggregated = {};
      sortedChainIds.forEach(function(chainId) {
        processChainForAgg(chainId, aggregated);
      });
    }

    function getTier(pct) {
      if (pct === 0) return 'awful';
      if (pct < 50) return 'abysmal';
      if (pct < 75) return 'fail';
      if (pct < 100) return 'missed';
      if (pct === 100) return 'success';
      return 'over';
    }

    var TIER_SCORES = { over: 3, success: 2, missed: 0, fail: -2, abysmal: -4, awful: -6 };
    var TIER_LABELS = { over: 'Over Achieved', success: 'Success', missed: 'Missed the Mark', fail: 'Fail', abysmal: 'Abysmal', awful: 'AWFUL' };

    function processChainForAgg(chainId, agg) {
      var chain = chains[chainId];
      var threshold = Math.floor(chain.length * 0.01);
      var rows = chainRows[chainId] || [];

      rows.forEach(function(row) {
        if (!currentMembers[row.memberId]) return;

        if (!agg[row.memberId]) {
          agg[row.memberId] = {
            name: currentMembers[row.memberId],
            totalHits: 0,
            totalRespect: 0,
            chainsPresent: 0,
            score: 0,
            tiers: { over: 0, success: 0, missed: 0, fail: 0, abysmal: 0, awful: 0 },
            allSuccess: true,
            allExceeded: true,
            chainData: {}
          };
        }

        var a = agg[row.memberId];
        var pct = threshold > 0 ? Math.round((row.hits / threshold) * 100) : 0;
        var tier = getTier(pct);

        a.totalHits += row.hits;
        a.totalRespect += row.respect;
        a.chainsPresent += 1;
        a.score += TIER_SCORES[tier];
        a.tiers[tier] += 1;
        if (tier !== 'over' && tier !== 'success') a.allSuccess = false;
        if (tier !== 'over') a.allExceeded = false;

        a.chainData[chainId] = {
          hits: row.hits,
          threshold: threshold,
          pct: pct,
          tier: tier
        };
      });
    }

    // ---- Stats ----

    function renderStats() {
      var ids = Object.keys(aggregated);
      var totalHits = 0;
      var offenderCount = 0;
      var exceededCount = 0;
      var consistentCount = 0;

      ids.forEach(function(id) {
        totalHits += aggregated[id].totalHits;
        if (aggregated[id].score < 0) offenderCount++;
        if (aggregated[id].allExceeded && aggregated[id].chainsPresent > 0) exceededCount++;
        else if (aggregated[id].allSuccess && aggregated[id].chainsPresent > 0) consistentCount++;
      });

      document.getElementById('statsRow').innerHTML =
        '<div class="stat-card"><div class="sc-label">Chains Tracked</div><div class="sc-value">' + sortedChainIds.length + '</div></div>' +
        '<div class="stat-card"><div class="sc-label">Current Members</div><div class="sc-value">' + Object.keys(currentMembers).length + '</div></div>' +
        '<div class="stat-card"><div class="sc-label">Total Hits</div><div class="sc-value green">' + formatNumber(totalHits) + '</div></div>' +
        '<div class="stat-card"><div class="sc-label">Exceeded</div><div class="sc-value green">' + exceededCount + '</div></div>' +
        '<div class="stat-card"><div class="sc-label">Consistent</div><div class="sc-value green">' + consistentCount + '</div></div>' +
        '<div class="stat-card"><div class="sc-label">Offenders</div><div class="sc-value red">' + offenderCount + '</div></div>';
    }

    // ---- Sorting ----

    var sortStates = {};

    function doSort(tableKey, data, col, renderFn) {
      if (!sortStates[tableKey]) sortStates[tableKey] = { col: null, asc: true };
      var s = sortStates[tableKey];
      if (s.col === col) { s.asc = !s.asc; }
      else { s.col = col; s.asc = col === 'name' ? true : false; }
      data.sort(function(a, b) {
        var av = a[col], bv = b[col];
        if (typeof av === 'string') return s.asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return s.asc ? av - bv : bv - av;
      });
      renderFn(data, s.col, s.asc);
    }

    function sc(col, activeCol, asc) {
      if (col !== activeCol) return '';
      return asc ? ' class="sorted-asc"' : ' class="sorted-desc"';
    }

    // ---- Exceeded (over 100% every chain) ----

    var exceededData = [];

    function renderExceeded(data, sortCol, sortAsc) {
      if (!data) {
        exceededData = [];
        Object.keys(aggregated).forEach(function(id) {
          var a = aggregated[id];
          if (!a.allExceeded || a.chainsPresent === 0) return;
          exceededData.push({
            id: parseInt(id),
            name: a.name,
            totalHits: a.totalHits,
            score: a.score,
            chainsPresent: a.chainsPresent
          });
        });
        exceededData.sort(function(a, b) { return b.totalHits - a.totalHits; });
        sortCol = 'totalHits'; sortAsc = false;
        sortStates['exceeded'] = { col: 'totalHits', asc: false };
        data = exceededData;
      }

      var h = '<tr>';
      h += '<th' + sc('name', sortCol, sortAsc) + ' onclick="doSort(\'exceeded\', exceededData, \'name\', renderExceeded)">Member</th>';
      h += '<th' + sc('totalHits', sortCol, sortAsc) + ' onclick="doSort(\'exceeded\', exceededData, \'totalHits\', renderExceeded)">Hits</th>';
      h += '<th' + sc('score', sortCol, sortAsc) + ' onclick="doSort(\'exceeded\', exceededData, \'score\', renderExceeded)">Score</th>';
      h += '<th' + sc('chainsPresent', sortCol, sortAsc) + ' onclick="doSort(\'exceeded\', exceededData, \'chainsPresent\', renderExceeded)">Chains</th>';
      h += '</tr>';
      document.getElementById('exceededHead').innerHTML = h;

      var body = '';
      data.forEach(function(row) {
        body += '<tr>';
        body += '<td><a href="https://www.torn.com/profiles.php?XID=' + row.id + '" target="_blank">' + row.name + '</a></td>';
        body += '<td>' + formatNumber(row.totalHits) + '</td>';
        body += '<td style="color: var(--green); font-weight: 600;">+' + row.score + '</td>';
        body += '<td>' + row.chainsPresent + '/' + sortedChainIds.length + '</td>';
        body += '</tr>';
      });
      document.getElementById('exceededBody').innerHTML = body || '<tr><td colspan="4" class="empty-state">No members exceeded in every chain</td></tr>';
    }

    // ---- Consistent (100% or more every chain, but not all exceeded) ----

    var consistentData = [];

    function renderConsistent(data, sortCol, sortAsc) {
      if (!data) {
        consistentData = [];
        Object.keys(aggregated).forEach(function(id) {
          var a = aggregated[id];
          if (a.allExceeded || !a.allSuccess || a.chainsPresent === 0) return;
          consistentData.push({
            id: parseInt(id),
            name: a.name,
            totalHits: a.totalHits,
            score: a.score,
            chainsPresent: a.chainsPresent,
            overCount: a.tiers.over,
            successCount: a.tiers.success
          });
        });
        consistentData.sort(function(a, b) { return b.score - a.score || b.totalHits - a.totalHits; });
        sortCol = 'score'; sortAsc = false;
        sortStates['consistent'] = { col: 'score', asc: false };
        data = consistentData;
      }

      var h = '<tr>';
      h += '<th' + sc('name', sortCol, sortAsc) + ' onclick="doSort(\'consistent\', consistentData, \'name\', renderConsistent)">Member</th>';
      h += '<th' + sc('totalHits', sortCol, sortAsc) + ' onclick="doSort(\'consistent\', consistentData, \'totalHits\', renderConsistent)">Hits</th>';
      h += '<th' + sc('score', sortCol, sortAsc) + ' onclick="doSort(\'consistent\', consistentData, \'score\', renderConsistent)">Score</th>';
      h += '<th>Breakdown</th>';
      h += '</tr>';
      document.getElementById('consistentHead').innerHTML = h;

      var body = '';
      data.forEach(function(row) {
        var breakdown = '';
        if (row.overCount > 0) breakdown += '<span class="pass-badge">' + row.overCount + ' Over</span> ';
        if (row.successCount > 0) breakdown += '<span class="pass-badge">' + row.successCount + ' Success</span>';
        body += '<tr>';
        body += '<td><a href="https://www.torn.com/profiles.php?XID=' + row.id + '" target="_blank">' + row.name + '</a></td>';
        body += '<td>' + formatNumber(row.totalHits) + '</td>';
        body += '<td style="color: var(--green); font-weight: 600;">+' + row.score + '</td>';
        body += '<td>' + breakdown + '</td>';
        body += '</tr>';
      });
      document.getElementById('consistentBody').innerHTML = body || '<tr><td colspan="4" class="empty-state">No members in this category</td></tr>';
    }

    // ---- Offenders (recent 5) ----

    var offenderData = [];

    function renderOffenders(data, sortCol, sortAsc) {
      if (!data) {
        offenderData = [];
        Object.keys(aggregated).forEach(function(id) {
          var a = aggregated[id];
          if (a.score >= 0) return;
          offenderData.push({
            id: parseInt(id),
            name: a.name,
            score: a.score,
            chainsPresent: a.chainsPresent,
            totalHits: a.totalHits,
            awful: a.tiers.awful,
            abysmal: a.tiers.abysmal,
            fail: a.tiers.fail,
            missed: a.tiers.missed,
            over: a.tiers.over,
            success: a.tiers.success
          });
        });
        offenderData.sort(function(a, b) { return a.score - b.score; });
        sortCol = 'score'; sortAsc = true;
        sortStates['offender'] = { col: 'score', asc: true };
        data = offenderData;
      }

      var h = '<tr>';
      h += '<th' + sc('name', sortCol, sortAsc) + ' onclick="doSort(\'offender\', offenderData, \'name\', renderOffenders)">Member</th>';
      h += '<th' + sc('score', sortCol, sortAsc) + ' onclick="doSort(\'offender\', offenderData, \'score\', renderOffenders)">Score</th>';
      h += '<th>Breakdown</th>';
      h += '<th' + sc('totalHits', sortCol, sortAsc) + ' onclick="doSort(\'offender\', offenderData, \'totalHits\', renderOffenders)">Total Hits</th>';
      h += '</tr>';
      document.getElementById('offenderHead').innerHTML = h;

      var body = '';
      data.forEach(function(row) {
        var parts = [];
        if (row.awful > 0) parts.push('<span class="fail-badge">' + row.awful + ' AWFUL</span>');
        if (row.abysmal > 0) parts.push('<span class="fail-badge">' + row.abysmal + ' Abysmal</span>');
        if (row.fail > 0) parts.push('<span class="fail-badge">' + row.fail + ' Fail</span>');
        if (row.missed > 0) parts.push('<span class="warn-badge">' + row.missed + ' Missed</span>');
        if (row.success > 0) parts.push('<span class="pass-badge">' + row.success + ' Success</span>');
        if (row.over > 0) parts.push('<span class="pass-badge">' + row.over + ' Over</span>');

        body += '<tr>';
        body += '<td><a href="https://www.torn.com/profiles.php?XID=' + row.id + '" target="_blank">' + row.name + '</a></td>';
        body += '<td style="color: var(--red); font-weight: 600;">' + row.score + '</td>';
        body += '<td>' + parts.join(' ') + '</td>';
        body += '<td>' + formatNumber(row.totalHits) + '</td>';
        body += '</tr>';
      });
      document.getElementById('offenderBody').innerHTML = body || '<tr><td colspan="4" class="empty-state">No offenders. Everyone is pulling their weight.</td></tr>';
    }

    // ---- All Members (all chains) ----

    var allMemberData = [];
    var memberSearchTerm = '';

    function buildAllMemberData() {
      allMemberData = [];
      Object.keys(currentMembers).forEach(function(id) {
        var numId = parseInt(id);
        var row = { id: numId, name: currentMembers[numId], chains: {} };
        sortedChainIds.forEach(function(cid) {
          if (aggregated[numId] && aggregated[numId].chainData[cid]) {
            row.chains[cid] = aggregated[numId].chainData[cid].pct;
          } else {
            row.chains[cid] = null;
          }
        });
        allMemberData.push(row);
      });
      allMemberData.sort(function(a, b) { return a.name.localeCompare(b.name); });
    }

    function renderAllMembers() {
      var h = '<tr><th>Member</th>';
      sortedChainIds.forEach(function(cid) {
        h += '<th>' + formatNumber(chains[cid].length) + '</th>';
      });
      h += '</tr>';
      document.getElementById('allHead').innerHTML = h;

      var filtered = allMemberData.filter(function(row) {
        if (!memberSearchTerm) return true;
        return row.name.toLowerCase().indexOf(memberSearchTerm.toLowerCase()) !== -1;
      });

      var body = '';
      filtered.forEach(function(row) {
        body += '<tr>';
        body += '<td><a href="https://www.torn.com/profiles.php?XID=' + row.id + '" target="_blank">' + row.name + '</a></td>';
        sortedChainIds.forEach(function(cid) {
          var pct = row.chains[cid];
          if (pct === null) {
            body += '<td class="pct-absent">--</td>';
          } else {
            body += '<td class="' + getPctClass(pct) + '">' + pct + '%</td>';
          }
        });
        body += '</tr>';
      });
      document.getElementById('allBody').innerHTML = body || '<tr><td colspan="' + (sortedChainIds.length + 1) + '" class="empty-state">No members found</td></tr>';
    }

    document.getElementById('memberSearch').addEventListener('input', function(e) {
      memberSearchTerm = e.target.value;
      renderAllMembers();
    });

    // ---- Chain Detail ----

    function populateChainSelect() {
      var select = document.getElementById('chainSelect');
      select.innerHTML = sortedChainIds.map(function(cid) {
        return '<option value="' + cid + '">' + formatNumber(chains[cid].length) + ' hits (ID: ' + cid + ')</option>';
      }).join('');
      select.addEventListener('change', function() {
        renderChainDetail(parseInt(select.value));
      });
    }

    function renderChainDetail(chainId) {
      var chain = chains[chainId];
      if (!chain) return;
      var threshold = Math.floor(chain.length * 0.01);

      document.getElementById('chainMeta').innerHTML =
        '<div class="cm-item"><div class="cm-label">Length</div><div class="cm-val">' + formatNumber(chain.length) + ' hits</div></div>' +
        '<div class="cm-item"><div class="cm-label">1% Threshold</div><div class="cm-val">' + threshold + ' hits</div></div>';

      var rows = (chainRows[chainId] || [])
        .filter(function(r) { return currentMembers[r.memberId]; })
        .map(function(r) {
          var pct = threshold > 0 ? Math.round((r.hits / threshold) * 100) : 0;
          var tier = getTier(pct);
          return {
            id: r.memberId,
            name: currentMembers[r.memberId],
            hits: r.hits,
            respect: Math.round(r.respect * 100) / 100,
            avgRespect: r.avgRespect,
            warHits: r.warHits,
            pct: pct,
            tier: tier
          };
        })
        .sort(function(a, b) { return b.hits - a.hits; });

      document.getElementById('chainHead').innerHTML =
        '<tr><th>Member</th><th>Hits</th><th>% of Threshold</th><th>Respect</th><th>Avg Respect</th><th>War Hits</th><th>Status</th></tr>';

      var body = '';
      rows.forEach(function(row) {
        var tierBadgeClass = { over: 'pass-badge', success: 'pass-badge', missed: 'warn-badge', fail: 'fail-badge', abysmal: 'fail-badge', awful: 'fail-badge' };
        var badge = '<span class="' + tierBadgeClass[row.tier] + '">' + TIER_LABELS[row.tier] + '</span>';
        body += '<tr>';
        body += '<td><a href="https://www.torn.com/profiles.php?XID=' + row.id + '" target="_blank">' + row.name + '</a></td>';
        body += '<td>' + formatNumber(row.hits) + '</td>';
        body += '<td class="' + getPctClass(row.pct) + '">' + row.pct + '%</td>';
        body += '<td>' + formatNumber(row.respect) + '</td>';
        body += '<td>' + row.avgRespect.toFixed(2) + '</td>';
        body += '<td>' + formatNumber(row.warHits) + '</td>';
        body += '<td>' + badge + '</td>';
        body += '</tr>';
      });
      document.getElementById('chainBody').innerHTML = body || '<tr><td colspan="7" class="empty-state">No data</td></tr>';
    }

    // ---- Theme ----

    function toggleTheme() {
      var current = document.documentElement.getAttribute('data-theme');
      var next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }

    function updateThemeBtn() {
      var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      document.getElementById('themeBtn').textContent = isDark ? '\u2600\uFE0F Light' : '\uD83C\uDF19 Dark';
    }

    (function() {
      var saved = localStorage.getItem('theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
      updateThemeBtn();
    })();

    // ---- Load ----

    async function loadAll() {
      try {
        setProgress(10, 'Fetching current faction members...');
        var membersResp = await fetch(TORN_BASE + '/faction/members', {
          headers: { 'Accept': 'application/json', 'Authorization': 'ApiKey ' + API_KEY }
        });
        if (!membersResp.ok) throw new Error('Members API returned ' + membersResp.status);
        var membersData = await membersResp.json();
        if (membersData.members) {
          membersData.members.forEach(function(m) { currentMembers[m.id] = m.name; });
        }

        setProgress(30, 'Fetching chain list...');
        var chainsResp = await fetch(CHAINS_CSV);
        if (!chainsResp.ok) throw new Error('Failed to load chains sheet');
        parseChainsCSV(await chainsResp.text());

        setProgress(50, 'Fetching chain reports...');
        var reportsResp = await fetch(REPORTS_CSV);
        if (!reportsResp.ok) throw new Error('Failed to load reports sheet');
        parseReportsCSV(await reportsResp.text());

        if (sortedChainIds.length === 0) {
          showError('No chain data found. Run the Apps Script first.');
          return;
        }

        setProgress(80, 'Processing...');
        processData();

        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');

        renderStats();
        renderExceeded();
        renderConsistent();
        renderOffenders();
        buildAllMemberData();
        renderAllMembers();
        populateChainSelect();
        renderChainDetail(sortedChainIds[0]);

      } catch (err) {
        showError('Failed to load: ' + err.message);
      }
    }

    loadAll();
  </script>
</body>
</html>
