<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Monitor</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="nav-brand">Resilience Dashboard</a>
  </nav>

  <div class="container">
    <div class="header">
      <h1>Energy Monitor</h1>
      <div class="controls">
        <input type="text" class="search-box" id="search" placeholder="Search member...">
        
        <div class="filter-group">
          <label>Status:</label>
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="miss">Below Min</button>
          <button class="filter-btn" data-filter="hit">Hit Min</button>
        </div>

        <div class="filter-group">
          <label>Weeks:</label>
          <select class="week-select" id="weekSelect">
            <option value="1">Last week</option>
            <option value="3" selected>Last 3 weeks</option>
            <option value="6">Last 6 weeks</option>
            <option value="12">Last 12 weeks</option>
            <option value="all">All weeks</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Min Daily Energy:</label>
          <input type="number" class="min-input" id="minEnergy" value="800" min="0">
        </div>
      </div>
      <div class="stats-bar">
        <div class="stat">Total: <span class="stat-count" id="totalCount">0</span></div>
        <div class="stat">Hit Min: <span class="stat-count green" id="hitCount">0</span></div>
        <div class="stat">Below Min: <span class="stat-count red" id="missCount">0</span></div>
        <div class="stat">Showing: <span class="stat-count" id="showingCount">0</span></div>
      </div>
    </div>

    <div class="table-wrapper">
      <table id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="loading" id="loading">Loading data...</div>
    </div>
  </div>

  <script>
    var CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQPU-ScBFwwLu_bMIgrhrA4EwScgrFv8XbK7d-BnCInHrKa0jbM1DbTXHZG8QlsD2vVn9iFI_BbNFLI/pub?gid=878473474&single=true&output=csv';

    var rawData = [];
    var headers = [];
    var weeks = [];
    var weekDays = {};
    var visibleWeeks = new Set();
    var currentFilter = 'all';
    var searchTerm = '';
    var sortCol = null;
    var sortAsc = true;
    var minEnergy = 800;

    var searchInput = document.getElementById('search');
    var weekSelect = document.getElementById('weekSelect');
    var minEnergyInput = document.getElementById('minEnergy');
    var tableHead = document.getElementById('tableHead');
    var tableBody = document.getElementById('tableBody');
    var loading = document.getElementById('loading');
    var filterBtns = document.querySelectorAll('.filter-btn');

    function parseWeekDate(weekStr) {
      var parts = weekStr.split(' ');
      var day = parseInt(parts[0]);
      var monthStr = parts[1];
      var months = {
        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
        'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
      };
      var month = months[monthStr];
      var year = new Date().getFullYear();
      return new Date(year, month, day);
    }

    function calculateWeekDays() {
      for (var i = 0; i < weeks.length; i++) {
        if (i === 0) {
          weekDays[weeks[i]] = 7;
        } else {
          var prevDate = parseWeekDate(weeks[i - 1]);
          var currDate = parseWeekDate(weeks[i]);
          var diffTime = Math.abs(currDate - prevDate);
          var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          weekDays[weeks[i]] = diffDays;
        }
      }
    }

    function hasData(week) {
      return rawData.some(function(row) {
        var energy = row[week + ' Energy'];
        return energy && energy !== '-' && energy !== '';
      });
    }

    fetch(CSV_URL)
      .then(function(r) { return r.text(); })
      .then(function(csv) {
        parseCSV(csv);
        loading.style.display = 'none';
        calculateWeekDays();
        weeks = weeks.filter(hasData);
        updateVisibleWeeks();
        renderTable();
      })
      .catch(function(err) {
        loading.textContent = 'Error loading data: ' + err.message;
      });

    function parseCSV(csv) {
      var rows = csv.trim().split('\n').map(function(r) {
        var result = [];
        var current = '';
        var inQuotes = false;
        
        for (var i = 0; i < r.length; i++) {
          var char = r[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      });

      headers = rows[0];
      rawData = rows.slice(1).map(function(row) {
        var obj = {};
        headers.forEach(function(h, i) {
          obj[h] = row[i] || '';
        });
        return obj;
      });

      weeks = [];
      var seen = new Set();
      headers.forEach(function(h) {
        var match = h.match(/^(\d+\s+\w+)\s+Energy$/);
        if (match && !seen.has(match[1])) {
          weeks.push(match[1]);
          seen.add(match[1]);
        }
      });
    }

    function updateVisibleWeeks() {
      var selection = weekSelect.value;
      
      if (selection === 'all') {
        visibleWeeks = new Set(weeks);
      } else {
        var count = parseInt(selection);
        var lastWeeks = weeks.slice(-count);
        visibleWeeks = new Set(lastWeeks);
      }
    }

    weekSelect.addEventListener('change', function() {
      updateVisibleWeeks();
      renderTable();
    });

    minEnergyInput.addEventListener('input', function(e) {
      minEnergy = parseInt(e.target.value) || 0;
      renderTable();
    });

    function getDailyAverage(energy, week) {
      var energyNum = parseInt(energy);
      if (isNaN(energyNum) || energy === '-') return null;
      var days = weekDays[week] || 7;
      return Math.round(energyNum / days);
    }

    function getLatestDailyEnergy(row) {
      var visibleWeeksOrdered = weeks.filter(function(w) { return visibleWeeks.has(w); }).reverse();
      
      for (var i = 0; i < visibleWeeksOrdered.length; i++) {
        var week = visibleWeeksOrdered[i];
        var energy = row[week + ' Energy'];
        var dailyAvg = getDailyAverage(energy, week);
        if (dailyAvg !== null) {
          return dailyAvg;
        }
      }
      return null;
    }

    function getStatus(row) {
      var latestEnergy = getLatestDailyEnergy(row);
      if (latestEnergy === null) return 'none';
      return latestEnergy >= minEnergy ? 'hit' : 'miss';
    }

    function renderTable() {
      var headerHTML = '<tr>';
      headerHTML += '<th onclick="sortBy(\'Username\')">Member</th>';

      weeks.forEach(function(week) {
        if (!visibleWeeks.has(week)) return;
        headerHTML += '<th class="week-header" onclick="sortBy(\'' + week + ' Energy\')">' + week + ' Avg/Day</th>';
        headerHTML += '<th onclick="sortBy(\'' + week + ' Trains\')">' + week + ' Trains</th>';
      });

      headerHTML += '</tr>';
      tableHead.innerHTML = headerHTML;

      if (sortCol) {
        var ths = tableHead.querySelectorAll('th');
        ths.forEach(function(th) {
          var thText = th.textContent.trim();
          if (thText === sortCol || (thText === 'Member' && sortCol === 'Username')) {
            th.classList.add(sortAsc ? 'sorted-asc' : 'sorted-desc');
          }
        });
      }

      rawData.forEach(function(row) {
        row['_status'] = getStatus(row);
        row['_latestEnergy'] = getLatestDailyEnergy(row);
      });

      var filtered = rawData.filter(function(row) {
        if (searchTerm && !row['Username']?.toLowerCase().includes(searchTerm.toLowerCase())) {
          return false;
        }
        if (currentFilter === 'miss' && row['_status'] !== 'miss') return false;
        if (currentFilter === 'hit' && row['_status'] !== 'hit') return false;
        return true;
      });

      if (sortCol) {
        filtered.sort(function(a, b) {
          var aVal = sortCol === 'Username' ? a['Username'] : a[sortCol];
          var bVal = sortCol === 'Username' ? b['Username'] : b[sortCol];

          if (aVal === '-') aVal = '';
          if (bVal === '-') bVal = '';

          var aNum = parseFloat(aVal);
          var bNum = parseFloat(bVal);

          if (!isNaN(aNum) && !isNaN(bNum)) {
            return sortAsc ? aNum - bNum : bNum - aNum;
          }

          aVal = aVal || '';
          bVal = bVal || '';

          return sortAsc 
            ? aVal.localeCompare(bVal, undefined, { numeric: true })
            : bVal.localeCompare(aVal, undefined, { numeric: true });
        });
      }

      var bodyHTML = '';
      filtered.forEach(function(row) {
        bodyHTML += '<tr>';
        bodyHTML += '<td>' + (row['Username'] || '') + '</td>';

        weeks.forEach(function(week) {
          if (!visibleWeeks.has(week)) return;

          var energy = row[week + ' Energy'] || '-';
          var trains = row[week + ' Trains'] || '-';
          var dailyAvg = getDailyAverage(energy, week);
          var displayEnergy = dailyAvg !== null ? dailyAvg : '-';

          var energyClass = 'week-cell';
          if (dailyAvg !== null && minEnergy > 0) {
            energyClass += dailyAvg >= minEnergy ? ' cell-hit' : ' cell-miss';
          }

          bodyHTML += '<td class="' + energyClass + '">' + displayEnergy + '</td>';
          bodyHTML += '<td>' + trains + '</td>';
        });

        bodyHTML += '</tr>';
      });

      tableBody.innerHTML = bodyHTML;

      var total = rawData.length;
      var hit = rawData.filter(function(r) { return r['_status'] === 'hit'; }).length;
      var miss = rawData.filter(function(r) { return r['_status'] === 'miss'; }).length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('hitCount').textContent = hit;
      document.getElementById('missCount').textContent = miss;
      document.getElementById('showingCount').textContent = filtered.length;
    }

    function sortBy(col) {
      if (sortCol === col) {
        sortAsc = !sortAsc;
      } else {
        sortCol = col;
        sortAsc = true;
      }
      renderTable();
    }

    searchInput.addEventListener('input', function(e) {
      searchTerm = e.target.value;
      renderTable();
    });

    filterBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        filterBtns.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderTable();
      });
    });
  </script>
  <script src="theme.js"></script>
</body>
</html>
